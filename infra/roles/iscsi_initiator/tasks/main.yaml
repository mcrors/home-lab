- name: Install required packages
  apt:
    name:
      - open-iscsi
    state: present
    update_cache: yes

- name: Set iSCSI InitiatorName dynamically
  become: true
  copy:
    dest: /etc/iscsi/initiatorname.iscsi
    content: |
      ## DO NOT EDIT OR REMOVE THIS FILE!
      ## If you remove this file, the iSCSI daemon will not start.
      ## If you change the InitiatorName, existing access control lists
      ## may reject this initiator.  The InitiatorName must be unique
      ## for each iSCSI initiator.  Do NOT duplicate iSCSI InitiatorNames.
      InitiatorName=iqn.1993-08.home.{{ ansible_hostname | regex_replace('\.home$', '') }}:01:initiator01
    owner: root
    group: root
    mode: '0644'

- name: Enable and start iSCSI target service
  systemd:
    name: iscsid
    enabled: yes
    state: restarted

- name: Enable and start iSCSI target service
  systemd:
    name: open-iscsi
    enabled: yes
    state: restarted

- name: Discover and login to iSCSI target
  become: true
  community.general.open_iscsi:
    auto_node_startup: true
    auto_portal_startup: true
    discover: true
    login: true
    portal: 192.168.1.74
    target: iqn.2025-02.home.lib-pi-06:lib-pi-06-target
    rescan: true
